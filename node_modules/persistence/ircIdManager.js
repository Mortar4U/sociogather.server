var Datastore = require("nedb");
var spromise  = require("spromise");

var ready = spromise.defer();
var db = {}, currentId = 1;

db.Ids = new Datastore({
  filename: "storage/ircIds.db",
  autoload: true,
  onload: function(err) {
    if ( err ) {
      ready.reject(err);
    }
    else {
      db.Ids.findOne({"id": "seed"}, function(err, result) {
        if ( result && result.value ) {
          currentId = result.value;
        }
        else {
          db.Ids.insert({"value": currentId, "id": "seed"}, function(){});
        }

        ready.resolve(db);
      });
    }
  }
});

db.Ids.loadDatabase();

function generateId() {
  currentId++;
  db.Ids.update({"id": "seed"}, {"value": currentId, "id": "seed"}, {}, function(){});
  return currentId;
}

module.exports = {
  ready: ready.promise,
  generateId: generateId
};
